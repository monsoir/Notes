# ä½¿ç”¨ TypeScript ç¼–å†™ npm åŒ…å¹¶è¿›è¡Œå‘å¸ƒ

å†…å®¹åŒ…æ‹¬

- æ­å»º TypeScript å¼€å‘ç¯å¢ƒ
- æ­å»ºæµ‹è¯•ç¯å¢ƒï¼Œä½¿ç”¨ TypeScript ç¼–å†™æµ‹è¯•ä»£ç 
- å°†åŒ…å‘å¸ƒåˆ° npm

## æ­å»º TypeScript å¼€å‘ç¯å¢ƒ

### åˆ›å»ºæºä»£ç æ–‡ä»¶å¤¹

åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ ğŸ“ `lib`, ç”¨äºå­˜æ”¾åŒ…çš„æ ¸å¿ƒä»£ç 

```
.
...
â”œâ”€â”€ lib
â”œâ”€â”€ node_modules
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
...
```

### å®‰è£…ä¾èµ–

VSCode å¯¹ TypeScript å†…ç½®æ”¯æŒï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨é¡¹ç›®ä¸­å®‰è£…å¯¹åº”çš„å¼€å‘ä¾èµ–

- typescript
- tslint 
    - TypeScript ä»£ç é£æ ¼æ£€æŸ¥å·¥å…·
- tslint-config-airbnb
    - tslint ç”¨äºæ£€æŸ¥ä»£ç é£æ ¼çš„å…¶ä¸­ä¸€ä¸ªè§„èŒƒ

```sh
npm i -D typescript tslint tslint-config-airbnb
```

### ä»£ç é£æ ¼æ£€æŸ¥é…ç½®

åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º tslint.json æ–‡ä»¶

```
.
â”œâ”€â”€ node_modules
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
...
â””â”€â”€ tslint.json
```

å¹¶åœ¨å…¶ä¸­æŒ‡å®šé£æ ¼è§„èŒƒ

```json
{
  "extends": "tslint-config-airbnb"
}
```

### TypeScript ç¼–è¯‘é€‰é¡¹é…ç½®

åˆ›å»ºä¸€ä¸ªğŸ“ `config`, å¹¶åˆ›å»ºæ–‡ä»¶ `tsconfig.base.json`, å­˜æ”¾ TypeScript ç¼–è¯‘çš„åŸºæœ¬é…ç½®

```
.
â”œâ”€â”€ config
â”‚Â Â  â””â”€â”€ tsconfig.base.json
...
```

è€Œè¿™ä¸ªåŸºç¡€é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ TypeScript å·¥å…·è‡ªåŠ¨ç”Ÿæˆï¼Œé»˜è®¤ç”Ÿæˆåˆ°é¡¹ç›®æ ¹ç›®å½•ï¼Œç§»åŠ¨ä¸€ä¸‹å°±å¥½äº†

```sh
npx tsc --init
```

---

#### åˆ›å»ºå‘å¸ƒçš„ä»£ç çš„ç¼–è¯‘é…ç½®

å‰é¢æ‰€åˆ›å»ºçš„ `tsconfig.base.json` å¯ä»¥ä½œä¸ºåŸºæœ¬çš„è®¾ç½®ï¼Œå­é…ç½®æ–‡ä»¶å¯ä»¥é€šè¿‡ç»§æ‰¿è¿™ä¸ªæ–‡ä»¶ï¼Œæ ¹æ®éœ€è¦æ·»åŠ æˆ–æ”¹å˜è®¾ç½®ï¼Œé¿å…é‡å¤é…ç½®

åœ¨æ ¹ç›®å½•ä¸‹ï¼Œåˆ›å»º `tsconfig.json`

```
.
â”œâ”€â”€ config
â”‚Â Â  â””â”€â”€ tsconfig.base.json
...
â”œâ”€â”€ tsconfig.json
...
```

å†™å…¥ä»¥ä¸‹é…ç½®

```json
{
  "extends": "./config/tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist"
  },
  "include": [
    "./lib"
  ],
  "exclude": [
    "./test",
    "node_modules"
  ]
}
```

- é…ç½®ç»§æ‰¿äº `./config/tsconfig.base.json`
- æŒ‡å®šäº†ç¼–è¯‘åçš„ä»£ç è¾“å‡ºç›®å½•ä¸º `./dist`
- åªç¼–è¯‘ `./lib` ä¸­çš„å†…å®¹
- å¿½ç•¥æµ‹è¯•ä»£ç  `./test` ä¸­çš„å†…å®¹ï¼Œä»¥åŠç¬¬ä¸‰æ–¹åŒ… `node_modules` ä¸­çš„å†…å®¹

> 1. ä¸ºä»€ä¹ˆè¦é€šè¿‡ç»§æ‰¿çš„æ–¹å¼æ¥ç¼–å†™é…ç½®æ–‡ä»¶ï¼Ÿ
> 
>   å› ä¸ºåœ¨å‘å¸ƒçš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦æºä»£ç ç¼–è¯‘åçš„ä»£ç ã€‚ä½†ç­‰ä¸‹æˆ‘ä»¬ä¹Ÿéœ€è¦ä½¿ç”¨ TypeScript æ¥ç¼–å†™æµ‹è¯•ä»£ç ï¼Œå¦‚æœå…±ç”¨ä¸€å¥—é…ç½®æ–‡ä»¶çš„è¯ï¼Œå‘å¸ƒä»£ç ä¸­å°±ä¼šåŒ…å«æµ‹è¯•ä»£ç ï¼Œè€Œæµ‹è¯•ä»£ç å¹¶ä¸éœ€è¦è·Ÿç€å‘å¸ƒ
>   å› æ­¤ï¼Œé€šè¿‡ç»§æ‰¿çš„åšæ³•ï¼Œç¼–å†™ä¸¤å¥—é…ç½®æ–‡ä»¶ï¼Œå°±å¯ä»¥æ ¹æ®å‘å¸ƒæˆ–æµ‹è¯•ç¯å¢ƒï¼Œç¼–è¯‘å‡ºæˆ‘ä»¬æ‰€éœ€è¦çš„ä»£ç 
> 
> 1. é€šè¿‡ `extends` è¿›è¡Œé…ç½®æ–‡ä»¶çš„ç»§æ‰¿
> 1. æ³¨æ„ç‚¹ï¼Œ`include` å’Œ `exclude` é…ç½®é¡¹æ˜¯ä¸ `compilerOptions` åŒçº§çš„

### ä¿®æ”¹æ‰§è¡Œè„šæœ¬

ä¸€åˆ‡é…ç½®ç»“æŸä¹‹åï¼Œå†ä¿®æ”¹ä¸€ä¸‹ npm çš„ script

```json
...
"scripts": {
    "build": "tsc -p tsconfig.json",
    ...
  },
...
```

å½“æ‰§è¡Œ `npm run build` åï¼Œä¸€åˆ‡æ­£å¸¸ï¼Œé‚£ä¹ˆï¼Œåœ¨ `./dist/` ä¸‹åº”è¯¥å°±èƒ½çœ‹åˆ°ç¼–è¯‘åçš„ä»£ç äº†

## æ­å»ºæµ‹è¯•ç¯å¢ƒï¼Œä½¿ç”¨ TypeScript ç¼–å†™æµ‹è¯•ä»£ç 

### å®‰è£…ä¾èµ–

ç¼–å†™æµ‹è¯•ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…æµ‹è¯•æ¡†æ¶ `mocha` ä¸æ–­è¨€åº“ `chai`

è€Œåœ¨ TypeScript ç¯å¢ƒç¼–å†™æµ‹è¯•ï¼Œè¿˜éœ€è¦å®‰è£…å®šä¹‰æ–‡ä»¶ `@types/mocha`, `@types/chai`

```sh
npm i -D mocha @types/mocha chai @types/chai
```

> å®é™…ä¸Šï¼Œè‹¥æƒ³ç›´æ¥å°† mocha åœ¨ TypeScript ç¯å¢ƒä¸‹æ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨ ts-mocha

### åˆ›å»ºæµ‹è¯•ä»£ç çš„ç¼–è¯‘é…ç½®

åœ¨æ ¹ç›®å½•ä¸‹ï¼Œåˆ›å»º `tsconfig.test.json`

```
.
â”œâ”€â”€ config
â”‚Â Â  â””â”€â”€ tsconfig.base.json
...
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tsconfig.test.json
...
```

å†™å…¥ä»¥ä¸‹é…ç½®

```json
{
  "extends": "./config/tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./test-dist"
  },
  "include": [
    "./lib",
    "./test"
  ]
}
```

- é…ç½®ç»§æ‰¿äº `./config/tsconfig.base.json`
- æŒ‡å®šäº†ç¼–è¯‘åçš„ä»£ç è¾“å‡ºç›®å½•ä¸º `./test-dist`
- åªç¼–è¯‘ `./lib` ä»¥åŠæµ‹è¯•ä»£ç  `./test` ä¸­çš„å†…å®¹

### ä¿®æ”¹æ‰§è¡Œè„šæœ¬

ä¸€åˆ‡é…ç½®ç»“æŸä¹‹åï¼Œå†ä¿®æ”¹ä¸€ä¸‹ npm çš„ script

```json
...
"scripts": {
    "build": "tsc -p tsconfig.json",
    "test": "tsc -p tsconfig.test.json && mocha ./test-dist/*"
  },
...
```

å½“æ‰§è¡Œ `npm run test` åï¼Œä¸€åˆ‡æ­£å¸¸ï¼Œé‚£ä¹ˆï¼Œåœ¨ `./test-dist` ä¸‹åº”è¯¥å°±èƒ½çœ‹åˆ°ç¼–è¯‘åçš„ä»£ç äº†ï¼Œå¹¶ä¸”åœ¨æ§åˆ¶å°ä¸­è¾“å‡ºæµ‹è¯•ä¿¡æ¯

## å°†åŒ…å‘å¸ƒåˆ° npm

### ä¿®æ”¹ package.json

- ä¿®æ”¹å…¥å£æ–‡ä»¶ `main`
- ä¿®æ”¹ API å®šä¹‰æ–‡ä»¶ `types`
- æ·»åŠ å‘å¸ƒé’©å­ `prepublish`

```json
...
"main": "./dist/index.js",
"types": "./dist/index.d.ts",
"scripts": {
  "prepublish": "npm run build",
  "dev": "rm -fr ./dist && tsc -p tsconfig.dev.json",
  "build": "rm -fr ./dist && tsc -p tsconfig.prod.json",
  "test": "ts-mocha -p ./tsconfig.test.json ./test/*"
},
...
```

- åœ¨ `main` å­—æ®µä¸­æŒ‡å®šåŒ…å…¥å£ä½ç½®ï¼Œç”±äºç¼–è¯‘åçš„ä»£ç éƒ½æ”¾ç½®åœ¨ ğŸ“ dist ä¸­ï¼Œå³å‘å¸ƒåˆ° npm çš„åŒ…ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼Œå¦åˆ™ï¼Œåœ¨å¼•å…¥æ¨¡å—åï¼Œæ— æ³•å¯¼å…¥ç›¸åº”çš„æ–¹æ³•ï¼Œé™¤éæ ¹ç›®å½•ä¸‹æœ‰ä¸€ä¸ª `index.js` æ–‡ä»¶å°†æ–¹æ³•å¯¼å‡º

    ```
    .
    â”œâ”€â”€ README.md
    â”œâ”€â”€ dist
    â”‚Â Â  â”œâ”€â”€ TypeOf.d.ts
    â”‚Â Â  â”œâ”€â”€ TypeOf.js
    â”‚Â Â  â”œâ”€â”€ index.d.ts
    â”‚Â Â  â””â”€â”€ index.js
    â””â”€â”€ package.json
    ```

- åŒæ—¶ä¹Ÿåœ¨ `types` å­—æ®µä¸­æŒ‡å®š API æ–‡ä»¶çš„è·¯å¾„

### æ·»åŠ å¿½ç•¥æ–‡ä»¶

å½“æˆ‘ä»¬å°†åŒ…å‘åˆ° npm ä¸Šæ—¶ï¼Œå®é™…ä¸Šåªéœ€è¦å°†ç¼–è¯‘åçš„ä»£ç å‘å¸ƒå‡ºå»å°±è¡Œï¼Œé¿å…å°†é¡¹ç›®ä¸­æ‰€æœ‰çš„æ–‡ä»¶å‘å¸ƒä¸Šå»ï¼Œè¿™æ ·ä¼šå¢å¤§ä½“ç§¯

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `.npmignore` æ–‡ä»¶

```sh
touch .npmignore
```

### å‘å¸ƒ

```sh
npm publish
```

> å‘å¸ƒå‰ï¼Œå¯èƒ½éœ€è¦åˆ° npm å®˜ç½‘ä¸Šæ³¨å†Œè´¦å·ï¼Œå¹¶æ·»åŠ åˆ°å½“å‰æ‰§è¡Œç¯å¢ƒ

åœ¨æ¯æ¬¡æ›´æ”¹å¥½ä»£ç ï¼Œéœ€è¦å‘å¸ƒå‰ï¼Œéƒ½åº”è¯¥å…ˆæ‰§è¡Œä»¥ä¸‹ç‰ˆæœ¬æ›´æ–°çš„å‘½ä»¤ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ä¿®æ”¹ `package.json` ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯

```sh
npm version patch
npm version minor
npm version major
```

## ä¾‹å­

- [params-mapper](https://github.com/Monsoir/params-mapper)

